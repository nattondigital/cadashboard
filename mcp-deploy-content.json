"import { createClient } from 'npm:@supabase/supabase-js@2'\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Client-Info, Apikey, Accept, Mcp-Session-Id',\n}\n\ninterface MCPMessage {\n  jsonrpc: '2.0'\n  id?: string | number\n  method?: string\n  params?: any\n  result?: any\n  error?: {\n    code: number\n    message: string\n    data?: any\n  }\n}\n\nconst sessions = new Map<string, { agentId?: string; initialized: boolean }>()\n\nfunction generateSessionId(): string {\n  return `mcp-session-${Date.now()}-${Math.random().toString(36).substring(7)}`\n}\n\nfunction createSSEMessage(message: MCPMessage): string {\n  return `data: ${JSON.stringify(message)}\\n\\n`\n}\n\nasync function handleMCPRequest(\n  message: MCPMessage,\n  sessionId: string,\n  supabase: any\n): Promise<MCPMessage> {\n  const { method, params, id } = message\n\n  const response: MCPMessage = {\n    jsonrpc: '2.0',\n    id: id || 1,\n  }\n\n  try {\n    switch (method) {\n      case 'initialize': {\n        const clientInfo = params?.clientInfo\n        const agentId = clientInfo?.agentId || params?.agentId\n\n        sessions.set(sessionId, {\n          initialized: true,\n          agentId: agentId\n        })\n\n        console.log('MCP session initialized', { sessionId, agentId })\n\n        response.result = {\n          protocolVersion: '2024-11-05',\n          capabilities: {\n            tools: {},\n            resources: {},\n            prompts: {},\n          },\n          serverInfo: {\n            name: 'crm-tasks-mcp-server',\n            version: '1.0.0',\n          },\n        }\n        break\n      }\n\n      case 'resources/list': {\n        response.result = {\n          resources: [\n            {\n              uri: 'tasks://all',\n              name: 'All Tasks',\n              description: 'Complete list of all tasks in the system',\n              mimeType: 'application/json',\n            },\n            {\n              uri: 'tasks://pending',\n              name: 'Pending Tasks',\n              description: 'Tasks with status \"To Do\" or \"In Progress\"',\n              mimeType: 'application/json',\n            },\n            {\n              uri: 'tasks://overdue',\n              name: 'Overdue Tasks',\n              description: 'Tasks that are past their due date',\n              mimeType: 'application/json',\n            },\n            {\n              uri: 'tasks://high-priority',\n              name: 'High Priority Tasks',\n              description: 'Tasks with priority \"High\" or \"Urgent\"',\n              mimeType: 'application/json',\n            },\n          ],\n        }\n        break\n      }\n\n      case 'resources/read': {\n        const { uri } = params\n\n        if (!uri) {\n          throw new Error('URI is required')\n        }\n\n        let query = supabase.from('tasks').select('*')\n\n        if (uri === 'tasks://pending') {\n          query = query.in('status', ['To Do', 'In Progress'])\n        } else if (uri === 'tasks://overdue') {\n          const today = new Date().toISOString().split('T')[0]\n          query = query\n            .lt('due_date', today)\n            .in('status', ['To Do', 'In Progress'])\n        } else if (uri === 'tasks://high-priority') {\n          query = query.in('priority', ['High', 'Urgent'])\n        }\n\n        const { data, error } = await query\n\n        if (error) throw error\n\n        response.result = {\n          contents: [\n            {\n              uri,\n              mimeType: 'application/json',\n              text: JSON.stringify(data, null, 2),\n            },\n          ],\n        }\n        break\n      }\n\n      case 'prompts/list': {\n        response.result = {\n          prompts: [\n            {\n              name: 'task_summary',\n              description: 'Provides a comprehensive summary of tasks including pending, overdue, and completed',\n              arguments: [],\n            },\n            {\n              name: 'task_creation_guide',\n              description: 'Best practices and guidelines for creating well-structured tasks',\n              arguments: [],\n            },\n            {\n              name: 'task_prioritization',\n              description: 'Recommendations for prioritizing and organizing tasks',\n              arguments: [\n                {\n                  name: 'user_context',\n                  description: 'Information about the user or team to personalize recommendations',\n                  required: false,\n                },\n              ],\n            },\n            {\n              name: 'overdue_alert',\n              description: 'Generate an alert message for overdue tasks that need attention',\n              arguments: [],\n            },\n            {\n              name: 'get_task_by_id',\n              description: 'Instructions for retrieving a specific task by its task_id (e.g., TASK-10031)',\n              arguments: [\n                {\n                  name: 'task_id',\n                  description: 'The task ID to retrieve (e.g., TASK-10031)',\n                  required: true,\n                },\n              ],\n            },\n          ],\n        }\n        break\n      }\n\n      case 'prompts/get': {\n        const { name, arguments: args = {} } = params\n\n        if (!name) {\n          throw new Error('prompt name is required')\n        }\n\n        if (name === 'task_summary') {\n          const { data: allTasks } = await supabase.from('tasks').select('*')\n\n          const today = new Date().toISOString().split('T')[0]\n          const pending = allTasks?.filter((t: any) => t.status === 'To Do' || t.status === 'In Progress') || []\n          const overdue = allTasks?.filter((t: any) => t.due_date < today && (t.status === 'To Do' || t.status === 'In Progress')) || []\n          const completed = allTasks?.filter((t: any) => t.status === 'Completed') || []\n\n          let summary = `# Task Summary Report\\n\\n`\n          summary += `**Total Tasks:** ${allTasks?.length || 0}\\n\\n`\n          summary += `## Status Breakdown\\n`\n          summary += `- \u2705 Completed: ${completed.length}\\n`\n          summary += `- \ud83d\udea7 Pending: ${pending.length}\\n`\n          summary += `- \u26a0\ufe0f Overdue: ${overdue.length}\\n\\n`\n\n          if (overdue.length > 0) {\n            summary += `## \u26a0\ufe0f Overdue Tasks (Immediate Attention)\\n`\n            overdue.forEach((task: any) => {\n              summary += `- **${task.title}** (${task.priority}) - Due: ${task.due_date}\\n`\n            })\n            summary += `\\n`\n          }\n\n          if (pending.length > 0) {\n            summary += `## \ud83d\udea7 Pending Tasks\\n`\n            pending.slice(0, 10).forEach((task: any) => {\n              summary += `- **${task.title}** (${task.status}) - Priority: ${task.priority}\\n`\n            })\n            if (pending.length > 10) {\n              summary += `\\n_... and ${pending.length - 10} more pending tasks_\\n`\n            }\n          }\n\n          response.result = {\n            messages: [\n              {\n                role: 'user',\n                content: {\n                  type: 'text',\n                  text: summary,\n                },\n              },\n            ],\n          }\n        } else if (name === 'task_creation_guide') {\n          const guide = `# Task Creation Guide\\n\\n## Best Practices\\n\\n1. **Clear Title**: Use descriptive, action-oriented titles\\n   - Good: \"Review Q1 financial report\"\\n   - Bad: \"Financial stuff\"\\n\\n2. **Detailed Description**: Include context, requirements, and success criteria\\n\\n3. **Priority Setting**:\\n   - Urgent: Must be done today\\n   - High: Important, should be done this week\\n   - Medium: Regular priority\\n   - Low: Nice to have\\n\\n4. **Due Dates**: Set realistic deadlines considering complexity\\n\\n5. **Assignment**: Assign to the most appropriate team member\\n\\n6. **Status Updates**: Keep tasks current\\n   - To Do: Not started\\n   - In Progress: Actively working\\n   - Completed: Finished\\n   - Cancelled: No longer needed\\n\\n## Example Task\\n\\n**Title:** Review and approve Q1 marketing budget\\n**Description:** Review the proposed Q1 marketing budget, verify alignment with strategic goals, and approve or request revisions. Include feedback on specific line items.\\n**Priority:** High\\n**Due Date:** Next Friday\\n**Assigned To:** Marketing Director`\n\n          response.result = {\n            messages: [\n              {\n                role: 'user',\n                content: {\n                  type: 'text',\n                  text: guide,\n                },\n              },\n            ],\n          }\n        } else if (name === 'task_prioritization') {\n          const context = args.user_context ? `\\n\\nUser Context: ${args.user_context}\\n` : ''\n\n          const prioritization = `# Task Prioritization Guidelines${context}\\n\\n## Priority Matrix\\n\\n### 1. Urgent + Important (Do First)\\n- Tasks with imminent deadlines\\n- Critical business operations\\n- Customer-facing issues\\n\\n### 2. Important + Not Urgent (Schedule)\\n- Strategic planning\\n- Relationship building\\n- Professional development\\n\\n### 3. Urgent + Not Important (Delegate)\\n- Some meetings\\n- Many emails\\n- Routine tasks that others can handle\\n\\n### 4. Not Urgent + Not Important (Eliminate)\\n- Time wasters\\n- Unnecessary activities\\n- Busy work\\n\\n## Practical Tips\\n\\n1. **Start with High-Priority Tasks**\\n   - Begin each day with your most important task\\n   - Don't let urgent-but-unimportant tasks hijack your day\\n\\n2. **Use the 2-Minute Rule**\\n   - If it takes less than 2 minutes, do it now\\n   - Otherwise, schedule or delegate it\\n\\n3. **Batch Similar Tasks**\\n   - Group similar activities together\\n   - Reduces context switching\\n   - Increases efficiency\\n\\n4. **Review Regularly**\\n   - Daily: Review today's tasks\\n   - Weekly: Plan the week ahead\\n   - Monthly: Adjust long-term priorities`\n\n          response.result = {\n            messages: [\n              {\n                role: 'user',\n                content: {\n                  type: 'text',\n                  text: prioritization,\n                },\n              },\n            ],\n          }\n        } else if (name === 'overdue_alert') {\n          const today = new Date().toISOString().split('T')[0]\n          const { data: overdueTasks } = await supabase\n            .from('tasks')\n            .select('*')\n            .lt('due_date', today)\n            .in('status', ['To Do', 'In Progress'])\n            .order('due_date', { ascending: true })\n\n          if (!overdueTasks || overdueTasks.length === 0) {\n            response.result = {\n              messages: [\n                {\n                  role: 'user',\n                  content: {\n                    type: 'text',\n                    text: '# Task Status: All Clear!\\n\\n\u2705 Great news! You have no overdue tasks at the moment.\\n\\nKeep up the excellent work on staying on top of your deadlines!',\n                  },\n                },\n              ],\n            }\n          } else {\n            let alert = `# \u26a0\ufe0f Overdue Tasks Alert\\n\\n`\n            alert += `You have **${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''}** that need immediate attention:\\n\\n`\n\n            overdueTasks.forEach((task: any, index: number) => {\n              const daysOverdue = Math.floor((new Date().getTime() - new Date(task.due_date).getTime()) / (1000 * 60 * 60 * 24))\n              alert += `${index + 1}. **${task.title}**\\n`\n              alert += `   - Priority: ${task.priority}\\n`\n              alert += `   - Due Date: ${task.due_date} (${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue)\\n`\n              alert += `   - Status: ${task.status}\\n`\n              if (task.assigned_to_name) {\n                alert += `   - Assigned to: ${task.assigned_to_name}\\n`\n              }\n              alert += `\\n`\n            })\n\n            alert += `## Recommended Actions\\n\\n`\n            alert += `1. Review each overdue task and update status if completed\\n`\n            alert += `2. For active tasks, assess if deadlines need adjustment\\n`\n            alert += `3. Prioritize overdue high-priority items immediately\\n`\n            alert += `4. Consider reassigning tasks if assignees are overloaded\\n`\n            alert += `5. Break down large overdue tasks into smaller, manageable pieces\\n`\n\n            response.result = {\n              messages: [\n                {\n                  role: 'user',\n                  content: {\n                    type: 'text',\n                    text: alert,\n                  },\n                },\n              ],\n            }\n          }\n        } else if (name === 'get_task_by_id') {\n          const taskId = args.task_id\n          if (!taskId) {\n            response.result = {\n              messages: [\n                {\n                  role: 'user',\n                  content: {\n                    type: 'text',\n                    text: '# How to Retrieve a Task by ID\\n\\nTo get details of a specific task, use the `get_tasks` tool with the `task_id` parameter:\\n\\n```json\\n{\\n  \"task_id\": \"TASK-10031\"\\n}\\n```\\n\\nThis will return the complete task details including:\\n- Task title and description\\n- Status and priority\\n- Assigned user and contact information\\n- Due dates and progress\\n- Supporting documents',\n                  },\n                },\n              ],\n            }\n          } else {\n            const { data: tasks } = await supabase\n              .from('tasks')\n              .select('*')\n              .eq('task_id', taskId)\n\n            if (!tasks || tasks.length === 0) {\n              response.result = {\n                messages: [\n                  {\n                    role: 'user',\n                    content: {\n                      type: 'text',\n                      text: `# Task Not Found\\n\\nTask **${taskId}** was not found in the system.\\n\\nPlease verify the task ID and try again.`,\n                    },\n                  },\n                ],\n              }\n            } else {\n              const task = tasks[0]\n              let details = `# Task Details: ${task.task_id}\\n\\n`\n              details += `## ${task.title}\\n\\n`\n\n              if (task.description) {\n                details += `**Description:** ${task.description}\\n\\n`\n              }\n\n              details += `### Status & Priority\\n`\n              details += `- **Status:** ${task.status}\\n`\n              details += `- **Priority:** ${task.priority}\\n`\n              details += `- **Progress:** ${task.progress_percentage}%\\n\\n`\n\n              details += `### Assignment\\n`\n              details += `- **Assigned to:** ${task.assigned_to_name || 'Unassigned'}\\n`\n              details += `- **Assigned by:** ${task.assigned_by_name || 'N/A'}\\n\\n`\n\n              if (task.contact_phone || task.contact_name) {\n                details += `### Contact\\n`\n                if (task.contact_name) {\n                  details += `- **Name:** ${task.contact_name}\\n`\n                }\n                if (task.contact_phone) {\n                  details += `- **Phone:** ${task.contact_phone}\\n`\n                }\n                details += `\\n`\n              }\n\n              if (task.due_date) {\n                details += `### Dates\\n`\n                details += `- **Due:** ${task.due_date}\\n`\n                details += `- **Created:** ${task.created_at}\\n\\n`\n              }\n\n              if (task.supporting_documents && task.supporting_documents.length > 0) {\n                details += `### Supporting Documents\\n`\n                task.supporting_documents.forEach((doc: string) => {\n                  details += `- ${doc}\\n`\n                })\n              }\n\n              response.result = {\n                messages: [\n                  {\n                    role: 'user',\n                    content: {\n                      type: 'text',\n                      text: details,\n                    },\n                  },\n                ],\n              }\n            }\n          }\n        } else {\n          throw new Error(`Unknown prompt: ${name}`)\n        }\n        break\n      }\n\n      case 'tools/list': {\n        response.result = {\n          tools: [\n            {\n              name: 'get_tasks',\n              description: 'Retrieve tasks with advanced filtering. Use task_id to get a specific task.',\n              inputSchema: {\n                type: 'object',\n                properties: {\n                  agent_id: {\n                    type: 'string',\n                    description: 'AI Agent ID for permission checking',\n                  },\n                  phone_number: {\n                    type: 'string',\n                    description: 'User phone number for logging',\n                  },\n                  task_id: {\n                    type: 'string',\n                    description: 'Get a specific task by its task_id (e.g., TASK-10031)',\n                  },\n                  status: {\n                    type: 'string',\n                    enum: ['To Do', 'In Progress', 'Completed', 'Cancelled'],\n                  },\n                  priority: {\n                    type: 'string',\n                    enum: ['Low', 'Medium', 'High', 'Urgent'],\n                  },\n                  limit: {\n                    type: 'number',\n                    description: 'Maximum number of tasks to return (default: 100)',\n                  },\n                },\n              },\n            },\n            {\n              name: 'create_task',\n              description: 'Create a new task',\n              inputSchema: {\n                type: 'object',\n                properties: {\n                  agent_id: {\n                    type: 'string',\n                    description: 'AI Agent ID for permission checking',\n                  },\n                  phone_number: {\n                    type: 'string',\n                    description: 'User phone number for logging',\n                  },\n                  title: {\n                    type: 'string',\n                    description: 'Task title',\n                  },\n                  description: {\n                    type: 'string',\n                    description: 'Task description',\n                  },\n                  priority: {\n                    type: 'string',\n                    enum: ['Low', 'Medium', 'High', 'Urgent'],\n                    description: 'Task priority (default: Medium)',\n                  },\n                  status: {\n                    type: 'string',\n                    enum: ['To Do', 'In Progress', 'Completed', 'Cancelled'],\n                    description: 'Task status (default: To Do)',\n                  },\n                  assigned_to: {\n                    type: 'string',\n                    description: 'UUID of assigned team member',\n                  },\n                  assigned_to_name: {\n                    type: 'string',\n                    description: 'Name of assigned team member (e.g., \"Amit\", \"Prince\")',\n                  },\n                  contact_id: {\n                    type: 'string',\n                    description: 'UUID of related contact',\n                  },\n                  due_date: {\n                    type: 'string',\n                    description: 'Due date (YYYY-MM-DD format)',\n                  },\n                  due_time: {\n                    type: 'string',\n                    description: 'Due time (HH:MM format, 24-hour)',\n                  },\n                  supporting_docs: {\n                    type: 'array',\n                    items: { type: 'string' },\n                    description: 'Array of document URLs or file paths',\n                  },\n                },\n                required: ['title'],\n              },\n            },\n            {\n              name: 'update_task',\n              description: 'Update an existing task',\n              inputSchema: {\n                type: 'object',\n                properties: {\n                  agent_id: {\n                    type: 'string',\n                    description: 'AI Agent ID for permission checking',\n                  },\n                  phone_number: {\n                    type: 'string',\n                    description: 'User phone number for logging',\n                  },\n                  task_id: {\n                    type: 'string',\n                    description: 'Task ID to update (e.g., TASK-10031)',\n                  },\n                  title: { type: 'string' },\n                  description: { type: 'string' },\n                  status: {\n                    type: 'string',\n                    enum: ['To Do', 'In Progress', 'Completed', 'Cancelled'],\n                  },\n                  priority: {\n                    type: 'string',\n                    enum: ['Low', 'Medium', 'High', 'Urgent'],\n                  },\n                  assigned_to: { type: 'string' },\n                  due_date: {\n                    type: 'string',\n                    description: 'Due date (YYYY-MM-DD format)',\n                  },\n                  due_time: {\n                    type: 'string',\n                    description: 'Due time (HH:MM format, 24-hour)',\n                  },\n                },\n                required: ['task_id'],\n              },\n            },\n            {\n              name: 'delete_task',\n              description: 'Delete a task by task_id',\n              inputSchema: {\n                type: 'object',\n                properties: {\n                  agent_id: {\n                    type: 'string',\n                    description: 'AI Agent ID for permission checking',\n                  },\n                  phone_number: {\n                    type: 'string',\n                    description: 'User phone number for logging',\n                  },\n                  task_id: {\n                    type: 'string',\n                    description: 'Task ID to delete (e.g., TASK-10031)',\n                  },\n                },\n                required: ['task_id'],\n              },\n            },\n          ],\n        }\n        break\n      }\n\n      case 'tools/call': {\n        const { name, arguments: args } = params\n        const agentId = args?.agent_id\n\n        if (!agentId) {\n          throw new Error('agent_id is required in arguments')\n        }\n\n        const { data: agent, error: agentError } = await supabase\n          .from('ai_agents')\n          .select('name')\n          .eq('id', agentId)\n          .maybeSingle()\n\n        if (agentError || !agent) {\n          throw new Error('Agent not found')\n        }\n\n        const agentName = agent.name\n\n        const { data: permissions, error: permError } = await supabase\n          .from('ai_agent_permissions')\n          .select('permissions')\n          .eq('agent_id', agentId)\n          .maybeSingle()\n\n        if (permError || !permissions) {\n          throw new Error('Agent not found or no permissions set')\n        }\n\n        const taskPerms = permissions.permissions?.Tasks || {}\n\n        switch (name) {\n          case 'get_tasks': {\n            try {\n              if (!taskPerms.can_view) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'get_tasks',\n                  result: 'Denied',\n                  user_context: args.phone_number || null,\n                  details: { reason: 'No permission to view tasks' },\n                })\n                throw new Error('Agent does not have permission to view tasks')\n              }\n\n              let query = supabase\n                .from('tasks')\n                .select('*')\n                .order('created_at', { ascending: false })\n\n              if (args.task_id) {\n                query = query.eq('task_id', args.task_id)\n              }\n              if (args.status) {\n                query = query.eq('status', args.status)\n              }\n              if (args.priority) {\n                query = query.eq('priority', args.priority)\n              }\n              if (args.limit) {\n                query = query.limit(args.limit)\n              } else {\n                query = query.limit(100)\n              }\n\n              const { data, error } = await query\n\n              if (error) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'get_tasks',\n                  result: 'Error',\n                  user_context: args.phone_number || null,\n                  details: { error: error.message },\n                })\n                throw error\n              }\n\n              await supabase.from('ai_agent_logs').insert({\n                agent_id: agentId,\n                agent_name: agentName,\n                module: 'Tasks',\n                action: 'get_tasks',\n                result: 'Success',\n                user_context: args.phone_number || null,\n                details: { filters: args, result_count: data?.length || 0 },\n              })\n\n              response.result = {\n                content: [\n                  {\n                    type: 'text',\n                    text: JSON.stringify(data, null, 2),\n                  },\n                ],\n              }\n            } catch (error) {\n              throw error\n            }\n            break\n          }\n\n          case 'create_task': {\n            try {\n              if (!taskPerms.can_create) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'create_task',\n                  result: 'Denied',\n                  user_context: args.phone_number || null,\n                  details: { reason: 'No permission to create tasks' },\n                })\n                throw new Error('Agent does not have permission to create tasks')\n              }\n\n              let dueDateTimestamp = null\n              if (args.due_date) {\n                if (args.due_time) {\n                  dueDateTimestamp = `${args.due_date}T${args.due_time}:00`\n                } else {\n                  dueDateTimestamp = `${args.due_date}T00:00:00`\n                }\n              }\n\n              let assignedToUuid = args.assigned_to || null\n              if (args.assigned_to_name && !assignedToUuid) {\n                const { data: userData } = await supabase\n                  .from('admin_users')\n                  .select('id')\n                  .ilike('full_name', `%${args.assigned_to_name}%`)\n                  .limit(1)\n                  .maybeSingle()\n\n                if (userData) {\n                  assignedToUuid = userData.id\n                }\n              }\n\n              const taskData = {\n                title: args.title,\n                description: args.description || null,\n                priority: args.priority || 'Medium',\n                status: args.status || 'To Do',\n                assigned_to: assignedToUuid,\n                contact_id: args.contact_id || null,\n                due_date: dueDateTimestamp,\n                supporting_documents: args.supporting_docs || null,\n              }\n\n              const { data, error } = await supabase\n                .from('tasks')\n                .insert(taskData)\n                .select()\n                .single()\n\n              if (error) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'create_task',\n                  result: 'Error',\n                  user_context: args.phone_number || null,\n                  details: { error: error.message, task_data: args },\n                })\n                throw error\n              }\n\n              await supabase.from('ai_agent_logs').insert({\n                agent_id: agentId,\n                agent_name: agentName,\n                module: 'Tasks',\n                action: 'create_task',\n                result: 'Success',\n                user_context: args.phone_number || null,\n                details: { task_id: data.task_id, title: args.title },\n              })\n\n              response.result = {\n                content: [\n                  {\n                    type: 'text',\n                    text: JSON.stringify({\n                      success: true,\n                      message: 'Task created successfully',\n                      task: data\n                    }, null, 2),\n                  },\n                ],\n              }\n            } catch (error) {\n              throw error\n            }\n            break\n          }\n\n          case 'update_task': {\n            try {\n              if (!taskPerms.can_edit) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'update_task',\n                  result: 'Denied',\n                  user_context: args.phone_number || null,\n                  details: { reason: 'No permission to edit tasks' },\n                })\n                throw new Error('Agent does not have permission to edit tasks')\n              }\n\n              const { task_id, due_time, ...updates } = args\n              delete updates.agent_id\n              delete updates.phone_number\n\n              // Handle due_date and due_time combination\n              if (args.due_date || due_time) {\n                let dueDateTimestamp = null\n                if (args.due_date) {\n                  if (due_time) {\n                    dueDateTimestamp = `${args.due_date}T${due_time}:00`\n                  } else {\n                    dueDateTimestamp = `${args.due_date}T00:00:00`\n                  }\n                  updates.due_date = dueDateTimestamp\n                }\n              }\n\n              const { data, error } = await supabase\n                .from('tasks')\n                .update(updates)\n                .eq('task_id', task_id)\n                .select()\n                .single()\n\n              if (error) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'update_task',\n                  result: 'Error',\n                  user_context: args.phone_number || null,\n                  details: { error: error.message, task_id, updates },\n                })\n                throw error\n              }\n\n              await supabase.from('ai_agent_logs').insert({\n                agent_id: agentId,\n                agent_name: agentName,\n                module: 'Tasks',\n                action: 'update_task',\n                result: 'Success',\n                user_context: args.phone_number || null,\n                details: { task_id, updates },\n              })\n\n              response.result = {\n                content: [\n                  {\n                    type: 'text',\n                    text: JSON.stringify({ success: true, message: 'Task updated successfully', task: data }),\n                  },\n                ],\n              }\n            } catch (error) {\n              throw error\n            }\n            break\n          }\n\n          case 'delete_task': {\n            try {\n              if (!taskPerms.can_delete) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'delete_task',\n                  result: 'Denied',\n                  user_context: args.phone_number || null,\n                  details: { reason: 'No permission to delete tasks' },\n                })\n                throw new Error('Agent does not have permission to delete tasks')\n              }\n\n              const { error } = await supabase\n                .from('tasks')\n                .delete()\n                .eq('task_id', args.task_id)\n\n              if (error) {\n                await supabase.from('ai_agent_logs').insert({\n                  agent_id: agentId,\n                  agent_name: agentName,\n                  module: 'Tasks',\n                  action: 'delete_task',\n                  result: 'Error',\n                  user_context: args.phone_number || null,\n                  details: { error: error.message, task_id: args.task_id },\n                })\n                throw error\n              }\n\n              await supabase.from('ai_agent_logs').insert({\n                agent_id: agentId,\n                agent_name: agentName,\n                module: 'Tasks',\n                action: 'delete_task',\n                result: 'Success',\n                user_context: args.phone_number || null,\n                details: { task_id: args.task_id },\n              })\n\n              response.result = {\n                content: [\n                  {\n                    type: 'text',\n                    text: JSON.stringify({ success: true, message: 'Task deleted successfully', task_id: args.task_id }),\n                  },\n                ],\n              }\n            } catch (error) {\n              throw error\n            }\n            break\n          }\n\n          default:\n            throw new Error(`Unknown tool: ${name}`)\n        }\n        break\n      }\n\n      default:\n        throw new Error(`Unknown method: ${method}`)\n    }\n  } catch (error: any) {\n    response.error = {\n      code: -32603,\n      message: error.message || 'Internal error',\n      data: error.stack,\n    }\n  }\n\n  return response\n}\n\nDeno.serve(async (req: Request) => {\n  if (req.method === 'OPTIONS') {\n    return new Response(null, {\n      status: 200,\n      headers: corsHeaders,\n    })\n  }\n\n  try {\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\n    const supabase = createClient(supabaseUrl, supabaseServiceKey)\n\n    let sessionId = req.headers.get('Mcp-Session-Id')\n    if (!sessionId) {\n      sessionId = generateSessionId()\n    }\n\n    const message: MCPMessage = await req.json()\n    const response = await handleMCPRequest(message, sessionId, supabase)\n\n    return new Response(JSON.stringify(response), {\n      status: 200,\n      headers: {\n        ...corsHeaders,\n        'Content-Type': 'application/json',\n        'Mcp-Session-Id': sessionId,\n      },\n    })\n  } catch (error: any) {\n    console.error('MCP Server Error:', error)\n    return new Response(\n      JSON.stringify({\n        jsonrpc: '2.0',\n        error: {\n          code: -32700,\n          message: 'Parse error',\n          data: error.message,\n        },\n      }),\n      {\n        status: 400,\n        headers: {\n          ...corsHeaders,\n          'Content-Type': 'application/json',\n        },\n      }\n    )\n  }\n})\n\n"